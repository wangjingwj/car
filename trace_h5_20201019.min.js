const AUTH_URL_TEST="https://m-test.jdallianz.com/jk/automobile/auto/gateway/",AUTH_URL_PRE="https://m-pre.jdallianz.com/jk/automobile/auto/gateway/",AUTH_URL_PROD="https://m.jdallianz.com/jk/automobile/auto/gateway/";let instance=null,appid=null,insureNo=null,token=null,apiEnable=!1,env_type="PRE",initing=!1,version=null,timerTask=null;function getUrl(){switch(env_type){case"TEST":return AUTH_URL_TEST;case"PRE":return AUTH_URL_PRE;case"PROD":return AUTH_URL_PROD;default:return AUTH_URL_TEST}}function httpRequest(e,n){return new Promise((t,i)=>{let r=new XMLHttpRequest;r.onload=()=>{let e=r.response;200===r.status&&"0000"===e.code&&e.data?t(e.data):i(e)},r.onerror=()=>{i("request error")},r.ontimeout=()=>{i("request timeout")},r.timeout=0,r.open("POST",e,!0),r.responseType="json",r.setRequestHeader("Content-Type","application/json;charset=UTF-8"),r.send(JSON.stringify(n))})}function zero(e){return e<10?"0"+e:e}function getDateStr(){let e=new Date(Date.now());return`${e.getFullYear()}${zero(e.getMonth()+1)}${zero(e.getDate())}`}function log(e,n){console.log("trace-h5-"+e,n)}const TraceUtils={initInstance(e,n,t,i){env_type=e||"TEST",version=n||"V1.0.0",initing=!0;let r="PROD"===env_type?"jdaz":"jdal";return new Promise(e=>{httpRequest(getUrl(),{userName:r,insuredNo:t||"",thirdTradeNo:i||""}).then(n=>{appid=n.appid,insureNo=n.insuredNo,token=n.insuredNoToken;let t={userName:r,url:n.url,timestamp:n.timestamp,appid:appid,signStr:n.sigstr,insureNo:insureNo,version:version};log("init-params",t),instance=new window.AnyChatRecallSDK(t),log("init-instance",instance),initing=!1,e(!0)}).catch(n=>{log("init-catch",n),this.clearTimer(),apiEnable=!1,appid=null,instance=null,insureNo=null,token=null,initing=!1,e(!1)})})},start(e,n){return new Promise(()=>{log("start-instance",instance),this.clearTimer(),instance?setTimeout(()=>{log("start","begin"),instance.start({interval:n,nodeName:e,event:e=>{log("start-res",e),apiEnable=e&&0===e.errorCode,this.handleError(e)}})},500):(log("start","setInterval"),timerTask=setInterval(()=>{instance?(this.clearTimer(),log("start","begin"),instance.start({interval:n,nodeName:e,event:e=>{log("start-res",e),apiEnable=e&&0===e.errorCode,this.handleError(e)}})):(apiEnable=!1,this.handleError(null))},800))})},stop(){return new Promise(e=>{if(this.clearTimer(),log("stop-apiEnable",apiEnable),instance&&apiEnable){let n=Date.now();log("stop","begin"),instance.stop({event:t=>{log("stop-during",Date.now()-n),log("stop-res",t),apiEnable=!1,e(t&&0===t.errorCode)}}),setTimeout(()=>{log("stop-timeout","timeout"),apiEnable=!1,e(!0)},500)}else apiEnable=!1,e(apiEnable)})},capture:e=>new Promise(n=>{log("capture-apiEnable",apiEnable),instance&&apiEnable?(log("capture","begin"),instance.capture({captureEle:e||"app",waterMark:getDateStr()+"京东安联",event:e=>{log("capture-res",e),n(e&&0===e.errorCode)}})):n(!1)}),stopAndCapture(e){return new Promise(n=>{this.clearTimer(),instance&&apiEnable?this.capture(e).then(()=>{this.stop().then(e=>{n(e)})}):n(!1)})},bind:e=>new Promise(n=>{log("bind-apiEnable",apiEnable),instance&&apiEnable?(log("bind","begin"),instance.bind({insureNo:insureNo,thirdTradeNo:e,appid:appid,status:1,event:e=>{log("bind-res",e),n(e&&0===e.errorCode)}})):n(!1)}),getCurrentTraceId:()=>insureNo||"",getToken:()=>token,handleError(e){e?500101===e.errorCode&&(log("handleError","sign expired"),instance=null,!initing&&this.initInstance(env_type,this.getCurrentTraceId())):!initing&&this.initInstance(env_type,version)},clearTimer(){timerTask&&(log("clearTimer","clearInterval"),clearInterval(timerTask),timerTask=null)},destroy(){log("destroy","destroy"),this.clearTimer(),appid=null,insureNo=null,token=null,apiEnable=null,env_type=null,initing=null,version=null,instance&&instance.destroy()}};window.TraceUtils=TraceUtils;